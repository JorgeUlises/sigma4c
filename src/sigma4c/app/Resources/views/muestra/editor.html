<link rel="stylesheet" href="http://openlayers.org/en/v3.18.2/css/ol.css" type="text/css">
<script src="http://openlayers.org/en/v3.18.2/build/ol.js"></script>

<div id="map" class="map"></div>

<ul class="list-inline">
  <li>
    <button type="button" class="btn btn-default" onclick="limpiarMapa()">Limpiar</button>
  </li>
  <li>

  </li>
</ul>

<div id="info" style="display: none;"></div>
<label for="track">
  Activar Geo Localización
  <input id="track" type="checkbox" />
</label>
<p>
  Exactitud de la posición: <code id="accuracy"></code>&nbsp;&nbsp;
  Altitud: <code id="altitude"></code>&nbsp;&nbsp;
  Exactitud de la altura: <code id="altitudeAccuracy"></code>&nbsp;&nbsp;
  Nutación: <code id="heading"></code>&nbsp;&nbsp;
  Velocidad: <code id="speed"></code>
</p>

<script>
function limpiarMapa () {
  features.clear()
  addInteraction()
  accuracyFeature.setGeometry()
  positionFeature.setGeometry()
  source.addFeatures([accuracyFeature, positionFeature])
  geolocation.setTracking(false)
}

var raster = new ol.layer.Tile({
  source: new ol.source.OSM()
})

var view = new ol.View({
  projection: 'EPSG:4326',
  center: [-74, 4 ],
  zoom: 4
})

var map = new ol.Map({
  layers: [raster],
  target: 'map',
  view: view
})

var listenerKey = map.on('postrender', function(e) {
  ol.Observable.unByKey(listenerKey)
  setInitialPoint()
})

var geolocation = new ol.Geolocation({
  projection: view.getProjection()
})

function el(id) {
  return document.getElementById(id)
}

function listener () {
  geolocation.setTracking(this.checked)
}

el('track').addEventListener('change', listener)

// update the HTML page when the position changes.
geolocation.on('change', function() {
  el('accuracy').innerText = geolocation.getAccuracy() + ' [m]'
  el('altitude').innerText = geolocation.getAltitude() + ' [m]'
  el('altitudeAccuracy').innerText = geolocation.getAltitudeAccuracy() + ' [m]'
  el('heading').innerText = geolocation.getHeading() + ' [rad]'
  el('speed').innerText = geolocation.getSpeed() + ' [m/s]'
  map.removeInteraction(draw)
  puntoTerminado()
})

// handle geolocation error.
geolocation.on('error', function(error) {
  var info = document.getElementById('info')
  info.innerHTML = error.message
  info.style.display = ''
})

var accuracyFeature = new ol.Feature()
geolocation.on('change:accuracyGeometry', function() {
  accuracyFeature.setGeometry(geolocation.getAccuracyGeometry())
  dataExtent = source.getExtent()
  view.fit(dataExtent, map.getSize())
})

var positionFeature = new ol.Feature()
var estiloPunto = new ol.style.Style({
  image: new ol.style.Circle({
    radius: 6,
    fill: new ol.style.Fill({
      color: '#3399CC'
    }),
    stroke: new ol.style.Stroke({
      color: '#fff',
      width: 2
    })
  })
})
positionFeature.setStyle(estiloPunto)

geolocation.on('change:position', function() {
  var coordinates = geolocation.getPosition()
  positionFeature.setGeometry(
    coordinates ? new ol.geom.Point(coordinates) : null
  )
})

var features = new ol.Collection()
var source = new ol.source.Vector({features: features})
var featureOverlay = new ol.layer.Vector({
  source: source,
  style: new ol.style.Style({
    fill: new ol.style.Fill({
      color: 'rgba(255, 255, 255, 0.2)'
    }),
    stroke: new ol.style.Stroke({
      color: '#ffcc33',
      width: 2
    }),
    image: new ol.style.Circle({
      radius: 7,
      fill: new ol.style.Fill({
        color: '#ffcc33'
      })
    })
  })
})
source.addFeatures([accuracyFeature, positionFeature])
featureOverlay.setMap(map)

var modify = new ol.interaction.Modify({
  features: features,
  // the SHIFT key must be pressed to delete vertices, so
  // that new vertices can be drawn at the same position
  // of existing vertices
  deleteCondition: function(event) {
    return ol.events.condition.shiftKeyOnly(event) &&
        ol.events.condition.singleClick(event)
  }
})
map.addInteraction(modify)

var draw // global so we can remove it later

function addInteraction() {
  draw = new ol.interaction.Draw({
    features: features,
    type: 'Point'
  })
  draw.on('drawend', drawEnd)
  map.addInteraction(draw)
}

var drawEnd = function() {
  map.removeInteraction(draw)
  setTimeout(puntoTerminado, 1000)
}

function puntoTerminado() {
  //window.alert('punto terminado')
  var featuresSource = source.getFeatures()
  //var featuresCollection = source.getFeaturesCollection().getArray()
  //featuresSource.concat(featuresCollection)
  for (var i=0; i<featuresSource.length; i++) {
    var feature = featuresSource[i]
    var geometry = feature.getGeometry()
    console.log(geometry)
    if (geometry != undefined) {
      if (geometry.getType() === 'Point') {
        var coordenadas = geometry.getCoordinates()
        var x = coordenadas[0]
        var y = coordenadas[1]
        el("muestra_geometria").value = x + "," + y
        console.log(x + "," + y)
      }
    }
  }
}


/**
 * Handle change event.
 */
addInteraction()

function setInitialPoint() {
  var coordenadas = el("muestra_geometria").value.split(' ')
  console.log(coordenadas);
  var x = coordenadas[0]
  var y = coordenadas[1]
  view.setZoom(16)
  view.setCenter([x, y])
  //var point = new ol.geom.Point([x, y])
  //var feature = new ol.Feature({
  //  geometry: point
  //})
  //feature.setStyle(estiloPunto)
  //source.addFeature(feature)
}

</script>
